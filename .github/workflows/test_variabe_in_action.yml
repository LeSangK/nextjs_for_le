name: Release to Production

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Bump version and create tag
        run: |
          echo NEW_TAG="v$(date +'%Y%m%d')" >> $GITHUB_ENV
      - name: Get draft release
        run: |
          RELEASE_ID=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    https://api.github.com/repos/${{ github.repository }}/releases \
               | jq '.[] | select(.draft==true) | .id')
          echo "RELEASE_ID=${RELEASE_ID}" >> $GITHUB_ENV
      - name: Update and publish release
        run: |
          curl -X PATCH \
             -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             -d '{"name": "${{ env.NEW_TAG }}", "tag_name": "${{ env.NEW_TAG }}", "draft": false}' \
             https://api.github.com/repos/${{ github.repository }}/releases/${{ env.RELEASE_ID }}
